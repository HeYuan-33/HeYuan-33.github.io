<!DOCTYPE html><html lang="zh-Cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>sherlock-Superfluid Locker System 审计报告 | 何方圜的博客</title><meta name="author" content="何方圜"><meta name="copyright" content="何方圜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一SummaryDue to the lack of access control on the stopFunding function, anyone can monitor the blockchain, identify a program with an active funding process, and maliciously call the stopFunding functi">
<meta property="og:type" content="article">
<meta property="og:title" content="sherlock-Superfluid Locker System 审计报告">
<meta property="og:url" content="http://example.com/2024/11/25/sherlock-Superfluid-Locker-System-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/index.html">
<meta property="og:site_name" content="何方圜的博客">
<meta property="og:description" content="一SummaryDue to the lack of access control on the stopFunding function, anyone can monitor the blockchain, identify a program with an active funding process, and maliciously call the stopFunding functi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/1219ec3412a4cedf9378f9c0b14545e1.jpg">
<meta property="article:published_time" content="2024-11-25T04:55:24.000Z">
<meta property="article:modified_time" content="2024-11-30T14:27:19.081Z">
<meta property="article:author" content="何方圜">
<meta property="article:tag" content="审计报告">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/1219ec3412a4cedf9378f9c0b14545e1.jpg"><link rel="shortcut icon" href="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg"><link rel="canonical" href="http://example.com/2024/11/25/sherlock-Superfluid-Locker-System-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'sherlock-Superfluid Locker System 审计报告',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-30 22:27:19'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">106</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/8a5725b44b17e750ba6ce84aaca3013d.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="何方圜的博客"><img class="site-icon" src="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg"/><span class="site-name">何方圜的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">sherlock-Superfluid Locker System 审计报告</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-11-25T04:55:24.000Z" title="Created 2024-11-25 12:55:24">2024-11-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-30T14:27:19.081Z" title="Updated 2024-11-30 22:27:19">2024-11-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="sherlock-Superfluid Locker System 审计报告"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一"><a href="#一" class="headerlink" title="一"></a>一</h1><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Due to the lack of access control on the stopFunding function, anyone can monitor the blockchain, identify a program with an active funding process, and maliciously call the stopFunding function to stop the program, resulting in improper fund allocation.<br>I know you have already described it<br><a target="_blank" rel="noopener" href="https://github.com/sherlock-audit/2024-11-superfluid-locking-contract-HeYuan-33?tab=readme-ov-file#q-please-discuss-any-design-choices-you-made">https://github.com/sherlock-audit/2024-11-superfluid-locking-contract-HeYuan-33?tab=readme-ov-file#q-please-discuss-any-design-choices-you-made</a><br>But can you be sure that the participant is not an attacker?</p>
<h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>Vulnerable code:</p>
<p>2024-11-superfluid-locking-contract-HeYuan-33&#x2F;fluid&#x2F;packages&#x2F;contracts&#x2F;src&#x2F;FluidEPProgramManager.sol</p>
<p>Line 294 in e0d5af5</p>
<p> function stopFunding(uint256 programId) external { </p>
<p>As we can see, the stopFunding function is only marked as external, meaning it can be called externally. This allows an attacker to freely stop a program, leading to improper fund allocation.<br>Internal pre-conditions<br>No response</p>
<h2 id="External-pre-conditions"><a href="#External-pre-conditions" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><p>The program ID is obtained by the attacker, and it is an actively running program.</p>
<h2 id="Attack-Path"><a href="#Attack-Path" class="headerlink" title="Attack Path"></a>Attack Path</h2><p>The attacker obtains an actively running program ID through blockchain monitoring.<br>The attacker calls the stopFunding function, causing the program to be forcibly stopped.</p>
<h2 id="Impact"><a href="#Impact" class="headerlink" title="Impact"></a>Impact</h2><p>An actively running program can be prematurely terminated.<br>Maliciously trigger related fund distribution and compensation operations.<br>If an attacker calls stopFunding, it will delete the program’s information, and it cannot be recovered permanently.</p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>Add a check to verify if the caller is a participant in the project, to prevent non-participants from calling the function.No matter what, adding a check for the caller is never a mistake.</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>这次的审计报告提交的很少，基本没有什么漏洞，这次主要是去看了合约的逻辑实现，其实一些精度计算，四舍五入的那些地方没有去仔细看，就忽略了这个漏洞，虽然这次提交又是被判为无效，但是也是知道了首先阅读审计开始前的要求，还有就是对于那些权限很松的注意一下抢跑攻击，比如这次的claim函数，就是和pool建立联系，但是攻击者也可以提前知道用户的交易，然后抢先去提交交易，让用户建立不了链接，以下是正确的报告。还是的学习怎么写poc测试。</p>
<h2 id="抢跑攻击"><a href="#抢跑攻击" class="headerlink" title="抢跑攻击"></a>抢跑攻击</h2><p>FluidLocker can be blocked from connecting to a pool</p>
<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><p>For FluidLockers to get money streamed into them they need to be connected to the distribution pools. This connection is established in claim function. However an attacker can observe locker transactions and call FluidEPProgramManager::UpdateUserUnits before user transactions go through. This will mark the signatures as used and update FluidLocker units without connecting the locker to the distribution pool.</p>
<h3 id="Root-Cause-1"><a href="#Root-Cause-1" class="headerlink" title="Root Cause"></a>Root Cause</h3><p>FluidLocker’s claim function updates locker units, verifies signatures and also establishes the connection between the locker and pool. <a target="_blank" rel="noopener" href="https://github.com/sherlock-audit/2024-11-superfluid-locking-contract/blob/1fa5f86024be5f269e1a0898b1f939f1d4cce149/fluid/packages/contracts/src/FluidLocker.sol#L155C1-L171C6">https://github.com/sherlock-audit/2024-11-superfluid-locking-contract/blob/1fa5f86024be5f269e1a0898b1f939f1d4cce149/fluid/packages/contracts/src/FluidLocker.sol#L155C1-L171C6</a>.<br>This connection will enable lockers to reflect their token balances on the event of a distribution, otherwise some address or the locker needs to manually claim for the locker.<br>However an attacker can observe user’s claim and call FluidEPProgramManager::UpdateUserUnits before user transactions go through. This will mark the signatures as used and update FluidLocker units without connecting the locker to the distribution pool.<br><a target="_blank" rel="noopener" href="https://github.com/sherlock-audit/2024-11-superfluid-locking-contract/blob/1fa5f86024be5f269e1a0898b1f939f1d4cce149/fluid/packages/contracts/src/EPProgramManager.sol#L119C1-L149C6">https://github.com/sherlock-audit/2024-11-superfluid-locking-contract/blob/1fa5f86024be5f269e1a0898b1f939f1d4cce149/fluid/packages/contracts/src/EPProgramManager.sol#L119C1-L149C6</a> (Note that the _poolUpdate of this function is overridden by FluidEPProgramManager’s _poolUpdate).</p>
<h3 id="Internal-pre-conditions"><a href="#Internal-pre-conditions" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h3><p>No response</p>
<h3 id="External-pre-conditions-1"><a href="#External-pre-conditions-1" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h3><p>No response</p>
<h3 id="Attack-Path-1"><a href="#Attack-Path-1" class="headerlink" title="Attack Path"></a>Attack Path</h3><p>User calls claim<br>Attacker front runs the call with FluidEPProgramManager::UpdateUserUnits with same parameters</p>
<h3 id="Impact-1"><a href="#Impact-1" class="headerlink" title="Impact"></a>Impact</h3><p>Although users can claim for the locker at any point, this is out of the ordinary flow and will be unexpected for the users, thus can lead to denial of funds for some time.</p>
<h3 id="PoC-1"><a href="#PoC-1" class="headerlink" title="PoC"></a>PoC</h3><p>No response</p>
<h3 id="Mitigation-1"><a href="#Mitigation-1" class="headerlink" title="Mitigation"></a>Mitigation</h3><p>Locker’s connection to the pool should be seperated from claims.</p>
<h2 id="四舍五入的问题，先除后乘，会导致精度损失"><a href="#四舍五入的问题，先除后乘，会导致精度损失" class="headerlink" title="四舍五入的问题，先除后乘，会导致精度损失"></a>四舍五入的问题，先除后乘，会导致精度损失</h2><p>When calculating in the _getUnlockingPercentage function, 540 was mistakenly used instead of 540 days for calculation. As a result, users can unlock all their funds earlier without paying penalties.</p>
<h3 id="Summary-2"><a href="#Summary-2" class="headerlink" title="Summary"></a>Summary</h3><p>When calculating in the _getUnlockingPercentage function, 540 was mistakenly used instead of 540 days for calculation. As a result, users can unlock all their funds earlier without paying penalties.</p>
<h3 id="Root-Cause-2"><a href="#Root-Cause-2" class="headerlink" title="Root Cause"></a>Root Cause</h3><p>In FluidLocker.sol#L388, 540 was mistakenly used instead of 540 days for calculation.<br>In FluidLocker.sol#L379-L381, since the minimum return of _getUnlockingPercentage is 269731 even if it is unlocked using the minimum unlocking period of 7 days(It is assumed that the accuracy problem in the calculation has been fixed.). This is greater than 10000. so it will result in an overflow of L381. This means that the user can’t use the vest form of unlocking. This forces the user to use _instantUnlock and pay an 80% penalty.</p>
<h3 id="Internal-pre-conditions-1"><a href="#Internal-pre-conditions-1" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h3><p>No response</p>
<h3 id="External-pre-conditions-2"><a href="#External-pre-conditions-2" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h3><p>No response</p>
<h3 id="Attack-Path-2"><a href="#Attack-Path-2" class="headerlink" title="Attack Path"></a>Attack Path</h3><p>No response</p>
<h3 id="Impact-2"><a href="#Impact-2" class="headerlink" title="Impact"></a>Impact</h3><p>Users have to pay an 80% penalty to unlock it. This has resulted in user losses.</p>
<h3 id="PoC-2"><a href="#PoC-2" class="headerlink" title="PoC"></a>PoC</h3><p>For simplicity, I directly changed the _getUnlockingPercentage function to public and fixed the error due to precision issues first. The code is as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function _getUnlockingPercentage(uint128 unlockPeriod) public pure returns (uint256 unlockingPercentageBP) &#123;  </span><br><span class="line">    unlockingPercentageBP = (  </span><br><span class="line">        _PERCENT_TO_BP  </span><br><span class="line">            * (  </span><br><span class="line">                // ((80 * _SCALER) / Math.sqrt(540 * _SCALER)) * (Math.sqrt(unlockPeriod * _SCALER) / _SCALER)  </span><br><span class="line">                (80 * _SCALER) * (Math.sqrt(unlockPeriod * _SCALER)) / Math.sqrt(540 * _SCALER)  </span><br><span class="line">                    + 20 * _SCALER  </span><br><span class="line">            )  </span><br><span class="line">    ) / _SCALER;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h3 id="poc-put-in-FluidLocker-t-sol"><a href="#poc-put-in-FluidLocker-t-sol" class="headerlink" title="poc(put in FluidLocker.t.sol):"></a>poc(put in FluidLocker.t.sol):</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function test_getUnlockingPercentage() external virtual &#123;  </span><br><span class="line">    FluidLocker(address(aliceLocker))._getUnlockingPercentage(7 days);  </span><br><span class="line">    FluidLocker(address(aliceLocker))._getUnlockingPercentage(540 days);  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="Resault"><a href="#Resault" class="headerlink" title="Resault:"></a>Resault:</h3><p>[PASS] test_getUnlockingPercentage() (gas: 22807)<br>Traces:<br>  [22807] FluidLockerTest::test_getUnlockingPercentage()<br>    ├─ [13073] BeaconProxy::_getUnlockingPercentage(604800 [6.048e5]) [staticcall]<br>    │   ├─ [2308] UpgradeableBeacon::implementation() [staticcall]<br>    │   │   └─ ← [Return] FluidLocker: [0x426eeFE8AF33482cA9F3ED139b1991984468926E]<br>    │   ├─ [2974] FluidLocker::_getUnlockingPercentage(604800 [6.048e5]) [delegatecall]<br>    │   │   └─ ← [Return] 269731 [2.697e5]<br>    │   └─ ← [Return] 269731 [2.697e5]<br>    ├─ [4055] BeaconProxy::_getUnlockingPercentage(46656000 [4.665e7]) [staticcall]<br>    │   ├─ [308] UpgradeableBeacon::implementation() [staticcall]<br>    │   │   └─ ← [Return] FluidLocker: [0x426eeFE8AF33482cA9F3ED139b1991984468926E]<br>    │   ├─ [2956] FluidLocker::_getUnlockingPercentage(46656000 [4.665e7]) [delegatecall]<br>    │   │   └─ ← [Return] 2353510 [2.353e6]<br>    │   └─ ← [Return] 2353510 [2.353e6]<br>    └─ ← [Stop]  </p>
<h3 id="Mitigation-2"><a href="#Mitigation-2" class="headerlink" title="Mitigation"></a>Mitigation</h3><pre><code>    unlockingPercentageBP = (  
        _PERCENT_TO_BP  
            * (  
</code></pre>
<ul>
<li><pre><code>               ((80 * _SCALER) / Math.sqrt(540 * _SCALER)) * (Math.sqrt(unlockPeriod * _SCALER) / _SCALER)
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>               (80 * _SCALER) * (Math.sqrt(unlockPeriod * _SCALER)) / Math.sqrt(540 days * _SCALER)  
                  + 20 * _SCALER  
          )  
  ) / _SCALER;
</code></pre>
</li>
</ul>
<h3 id="计算错误，导致固定的比例，这篇报告真的受膜拜"><a href="#计算错误，导致固定的比例，这篇报告真的受膜拜" class="headerlink" title="计算错误，导致固定的比例，这篇报告真的受膜拜"></a>计算错误，导致固定的比例，这篇报告真的受膜拜</h3><p>Invalid vest unlock flow rate calculations in FluidLocker::_vestUnlock(…) leads to recepients paying much higher tax rates than intended</p>
<h3 id="Summary-3"><a href="#Summary-3" class="headerlink" title="Summary"></a>Summary</h3><p>The FluidLocker contract allows users to lock FLUID tokens, and then at specific unlockPeriods to unlock them. When unlocking, users can choose to do it either instantly, and pay an 80% tax fee to stakers, or use a vesting scheme, where funds are flown to the user, using a Fontaine, based on the unlock period chosen. However, with the current logic in FluidLocker::_vestUnlock(…), there is no difference if a recipient unlocks with unlockPeriod &#x3D; 0 or unlockPeriod &#x3D; 540 days as there will be a constant 80% tax.</p>
<h3 id="Root-Cause-3"><a href="#Root-Cause-3" class="headerlink" title="Root Cause"></a>Root Cause</h3><p>In FluidLocker::_getUnlockingPercentage(…) invalid calculations are being carried out, leading to the function always producing a result of 2000, no matter what unlockPeriod is given. Because of this, the resulting unlockFlowRate will always be capped at 20% meaning that recipients who unlock at the max period will pay a constant tax of 80% to stakers, as if they unlocked at the very beginning.</p>
<h3 id="Internal-pre-conditions-2"><a href="#Internal-pre-conditions-2" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h3><p>N&#x2F;A</p>
<h3 id="External-pre-conditions-3"><a href="#External-pre-conditions-3" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h3><p>N&#x2F;A</p>
<h3 id="Attack-Path-3"><a href="#Attack-Path-3" class="headerlink" title="Attack Path"></a>Attack Path</h3><p>Locker A’s owner unlocks tokens for Alice with an unlock period of 0.<br>Alice pays 80% tax rate to instantly receive her tokens.<br>Locker A’s owner unlocks tokens for Bob with an unlockPeriod of 540 days.<br>Bob should pay 0 % tax, however due to improper calculations, he ends up paying 80% tax as well.,<br>Impact<br>FluidLocker::unlock(…) recipients who choose to unlock using the vesting option pay higher taxes than intended, thus receiving fewer tokens than what they should be.</p>
<h3 id="PoC-3"><a href="#PoC-3" class="headerlink" title="PoC"></a>PoC</h3><p>The following test can be added in FluidLocker.t.sol and ran with forge test –mt test_getUnlockingPercentage -vv</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uint256 private constant _SCALER = 1e18;  </span><br><span class="line">  </span><br><span class="line">uint256 private constant _PERCENT_TO_BP = 100;  </span><br><span class="line">  </span><br><span class="line">function _getUnlockingPercentage(uint128 unlockPeriod) internal pure returns (uint256 unlockingPercentageBP) &#123;  </span><br><span class="line">    unlockingPercentageBP = (  </span><br><span class="line">        _PERCENT_TO_BP  </span><br><span class="line">            * (  </span><br><span class="line">                ((80 * _SCALER) / Math.sqrt(540 * _SCALER)) * (Math.sqrt(unlockPeriod * _SCALER) / _SCALER)  </span><br><span class="line">                    + 20 * _SCALER  </span><br><span class="line">            )  </span><br><span class="line">    ) / _SCALER;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// Add this test function to your FluidLockerTest contract  </span><br><span class="line">function test_getUnlockingPercentage() public &#123;  </span><br><span class="line">    // Create a helper function to access the internal function  </span><br><span class="line">  </span><br><span class="line">    // Test different periods  </span><br><span class="line">    uint128 sevenDays = 7 days;  </span><br><span class="line">    uint128 thirtyDays = 30 days;  </span><br><span class="line">    uint128 ninetyDays = 90 days;  </span><br><span class="line">    uint128 oneEightyDays = 180 days;  </span><br><span class="line">    uint128 fiveFortyDays = 540 days;  </span><br><span class="line">  </span><br><span class="line">    uint256 sevenDaysPercent = _getUnlockingPercentage(sevenDays);  </span><br><span class="line">    uint256 thirtyDaysPercent = _getUnlockingPercentage(thirtyDays);  </span><br><span class="line">    uint256 ninetyDaysPercent = _getUnlockingPercentage(ninetyDays);  </span><br><span class="line">    uint256 oneEightyDaysPercent = _getUnlockingPercentage(oneEightyDays);  </span><br><span class="line">    uint256 fiveFortyDaysPercent = _getUnlockingPercentage(fiveFortyDays);  </span><br><span class="line">  </span><br><span class="line">    console.log(&quot;7 days unlock percentage:&quot;, sevenDaysPercent);  </span><br><span class="line">    console.log(&quot;30 days unlock percentage:&quot;, thirtyDaysPercent);  </span><br><span class="line">    console.log(&quot;90 days unlock percentage:&quot;, ninetyDaysPercent);  </span><br><span class="line">    console.log(&quot;180 days unlock percentage:&quot;, oneEightyDaysPercent);  </span><br><span class="line">    console.log(&quot;540 days unlock percentage:&quot;, fiveFortyDaysPercent);  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>And the output is:</p>
<p>Ran 1 test for test&#x2F;FluidLocker.t.sol:FluidLockerTest<br>[PASS] test_getUnlockingPercentage() (gas: 19376)<br>Logs:<br>  7 days unlock percentage: 2000<br>  30 days unlock percentage: 2000<br>  90 days unlock percentage: 2000<br>  180 days unlock percentage: 2000<br>  540 days unlock percentage: 2000  </p>
<p>Suite result: ok. 1 passed; 0 failed; 0 skipped; finished in 11.22ms (886.54µs CPU time)  </p>
<p>Ran 1 test suite in 159.53ms (11.22ms CPU time): 1 tests passed, 0 failed, 0 skipped (1 total tests)<br>Mitigation<br>Divide the current _getUnlockingPercentage calculations into batches to ensure proper truncation:</p>
<p>index f31ad92..f39a89a 100644  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--- a/fluid/packages/contracts/src/FluidLocker.sol  </span><br><span class="line">+++ b/fluid/packages/contracts/src/FluidLocker.sol  </span><br><span class="line">@@ -382,13 +382,14 @@ contract FluidLocker is Initializable, ReentrancyGuard, IFluidLocker &#123;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     function _getUnlockingPercentage(uint128 unlockPeriod) internal pure returns (uint256 unlockingPercentageBP) &#123;  </span><br><span class="line">-        unlockingPercentageBP = (  </span><br><span class="line">-            _PERCENT_TO_BP  </span><br><span class="line">-                * (  </span><br><span class="line">-                    ((80 * _SCALER) / Math.sqrt(540 * _SCALER)) * (Math.sqrt(unlockPeriod * _SCALER) / _SCALER)  </span><br><span class="line">-                        + 20 * _SCALER  </span><br><span class="line">-                )  </span><br><span class="line">-        ) / _SCALER;  </span><br><span class="line">+        // First calculate sqrt(unlockPeriod/_MAX_UNLOCK_PERIOD)  </span><br><span class="line">+        uint256 periodRatio = Math.sqrt((unlockPeriod * _SCALER) / _MAX_UNLOCK_PERIOD);  </span><br><span class="line">+  </span><br><span class="line">+        // Scale it to the range [20, 100]  </span><br><span class="line">+        uint256 percentage = 20 + ((80 * periodRatio) / Math.sqrt(_SCALER));  </span><br><span class="line">+  </span><br><span class="line">+        // Convert to basis points (multiply by 100)  </span><br><span class="line">+        unlockingPercentageBP = percentage * 100;  </span><br><span class="line">     &#125;  </span><br></pre></td></tr></table></figure>
<p>With the above change, the test output looks like this:</p>
<p>Ran 1 test for test&#x2F;FluidLocker.t.sol:FluidLockerTest<br>[PASS] test_getUnlockingPercentage() (gas: 18470)<br>Logs:<br>  7 days unlock percentage: 2900<br>  30 days unlock percentage: 3800<br>  90 days unlock percentage: 5200<br>  180 days unlock percentage: 6600<br>  540 days unlock percentage: 10000  </p>
<p>Suite result: ok. 1 passed; 0 failed; 0 skipped; finished in 11.90ms (1.07ms CPU time)  </p>
<p>Ran 1 test suite in 160.39ms (11.90ms CPU time): 1 tests passed, 0 failed, 0 skipped (1 total tests)  </p>
<p>就是要对于计算，比如，先除后乘就会导致一些精度的损失，或者是计算太大，还有一种的实现方式就是写测试文件</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">何方圜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/11/25/sherlock-Superfluid-Locker-System-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/">http://example.com/2024/11/25/sherlock-Superfluid-Locker-System-审计报告/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://https://HeYuan-33.github.io/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/">审计报告</a></div><div class="post_share"><div class="social-share" data-image="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/11/30/CTF-TrusterLenderPool/" title="CTF-TrusterLenderPool"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">CTF-TrusterLenderPool</div></div></a></div><div class="next-post pull-right"><a href="/2024/11/24/sherlock-2024-11-debita-Finance-V3/" title="sherlock-2024-11-debita Finance V3 审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">sherlock-2024-11-debita Finance V3 审计报告</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/11/11/CodeHawks-GivingThanks%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="CodeHawks-GivingThanks审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-11</div><div class="title">CodeHawks-GivingThanks审计报告</div></div></a></div><div><a href="/2025/03/13/cantina-size-Credit/" title="cantina-size Credit"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-13</div><div class="title">cantina-size Credit</div></div></a></div><div><a href="/2025/05/04/code4rena-Kinetiq/" title="code4rena-Kinetiq"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-04</div><div class="title">code4rena-Kinetiq</div></div></a></div><div><a href="/2024/12/04/codeHawks-2024-11-twentyone-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="codeHawks-2024-11-twentyone 审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-04</div><div class="title">codeHawks-2024-11-twentyone 审计报告</div></div></a></div><div><a href="/2025/04/18/codehawk-Liquidity-Management/" title="codehawk-Liquidity Management"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-18</div><div class="title">codehawk-Liquidity Management</div></div></a></div><div><a href="/2024/12/16/codeHawks-2024-12-Aldo-SssTablecoinsss-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="codeHawks-2024-12-Aldo SssTablecoinsss 审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-16</div><div class="title">codeHawks-2024-12-Aldo SssTablecoinsss 审计报告</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">何方圜</div><div class="author-info__description">夫孰异道而相安</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">106</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HeYuan-33/HeYuan-33.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HeYuan-33" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="/1405269390@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">CTF的更新</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80"><span class="toc-text">一</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A2%E8%B7%91%E6%94%BB%E5%87%BB"><span class="toc-text">抢跑攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-1"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Cause-1"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Internal-pre-conditions"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#External-pre-conditions-1"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Path-1"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impact-1"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PoC-1"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mitigation-1"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E5%85%88%E9%99%A4%E5%90%8E%E4%B9%98%EF%BC%8C%E4%BC%9A%E5%AF%BC%E8%87%B4%E7%B2%BE%E5%BA%A6%E6%8D%9F%E5%A4%B1"><span class="toc-text">四舍五入的问题，先除后乘，会导致精度损失</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-2"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Cause-2"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Internal-pre-conditions-1"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#External-pre-conditions-2"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Path-2"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impact-2"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PoC-2"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-put-in-FluidLocker-t-sol"><span class="toc-text">poc(put in FluidLocker.t.sol):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Resault"><span class="toc-text">Resault:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mitigation-2"><span class="toc-text">Mitigation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E9%94%99%E8%AF%AF%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%9B%BA%E5%AE%9A%E7%9A%84%E6%AF%94%E4%BE%8B%EF%BC%8C%E8%BF%99%E7%AF%87%E6%8A%A5%E5%91%8A%E7%9C%9F%E7%9A%84%E5%8F%97%E8%86%9C%E6%8B%9C"><span class="toc-text">计算错误，导致固定的比例，这篇报告真的受膜拜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-3"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Cause-3"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Internal-pre-conditions-2"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#External-pre-conditions-3"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Path-3"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PoC-3"><span class="toc-text">PoC</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/19/%E5%85%B3%E4%BA%8EOPE/" title="关于OPE">关于OPE</a><time datetime="2025-06-19T07:29:54.000Z" title="Created 2025-06-19 15:29:54">2025-06-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/17/sherlock-S-locker-System/" title="sherlock-S-locker System">sherlock-S-locker System</a><time datetime="2025-06-17T13:52:52.000Z" title="Created 2025-06-17 21:52:52">2025-06-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/17/sherlock-DODO-Cross-Chain-DEX/" title="sherlock-DODO Cross-Chain DEX">sherlock-DODO Cross-Chain DEX</a><time datetime="2025-06-17T13:38:04.000Z" title="Created 2025-06-17 21:38:04">2025-06-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/16/%E5%8D%95%E6%9C%BA%E7%89%88%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="单机版区块链的实现">单机版区块链的实现</a><time datetime="2025-06-16T12:14:36.000Z" title="Created 2025-06-16 20:14:36">2025-06-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/10/sherlock-Usual-ETH0/" title="sherlock-Usual ETH0">sherlock-Usual ETH0</a><time datetime="2025-06-10T13:33:05.000Z" title="Created 2025-06-10 21:33:05">2025-06-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/8a5725b44b17e750ba6ce84aaca3013d.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 何方圜</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
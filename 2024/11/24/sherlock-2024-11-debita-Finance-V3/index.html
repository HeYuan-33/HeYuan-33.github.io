<!DOCTYPE html><html lang="zh-Cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>sherlock-2024-11-debita Finance V3 审计报告 | 何方圜的博客</title><meta name="author" content="何方圜"><meta name="copyright" content="何方圜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一SummaryThere is no verification of the incentives recipient, which allows anyone to impersonate other borrowers and claim their incentives. Root CauseVulnerable code: 2024-11-debita-finance-v3-HeYuan">
<meta property="og:type" content="article">
<meta property="og:title" content="sherlock-2024-11-debita Finance V3 审计报告">
<meta property="og:url" content="http://example.com/2024/11/24/sherlock-2024-11-debita-Finance-V3/index.html">
<meta property="og:site_name" content="何方圜的博客">
<meta property="og:description" content="一SummaryThere is no verification of the incentives recipient, which allows anyone to impersonate other borrowers and claim their incentives. Root CauseVulnerable code: 2024-11-debita-finance-v3-HeYuan">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/1219ec3412a4cedf9378f9c0b14545e1.jpg">
<meta property="article:published_time" content="2024-11-24T09:02:31.000Z">
<meta property="article:modified_time" content="2024-11-26T15:07:34.681Z">
<meta property="article:author" content="何方圜">
<meta property="article:tag" content="审计报告">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/1219ec3412a4cedf9378f9c0b14545e1.jpg"><link rel="shortcut icon" href="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg"><link rel="canonical" href="http://example.com/2024/11/24/sherlock-2024-11-debita-Finance-V3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'sherlock-2024-11-debita Finance V3 审计报告',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-26 23:07:34'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">91</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/8a5725b44b17e750ba6ce84aaca3013d.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="何方圜的博客"><img class="site-icon" src="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg"/><span class="site-name">何方圜的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">sherlock-2024-11-debita Finance V3 审计报告</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-11-24T09:02:31.000Z" title="Created 2024-11-24 17:02:31">2024-11-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-26T15:07:34.681Z" title="Updated 2024-11-26 23:07:34">2024-11-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="sherlock-2024-11-debita Finance V3 审计报告"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一"><a href="#一" class="headerlink" title="一"></a>一</h1><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>There is no verification of the incentives recipient, which allows anyone to impersonate other borrowers and claim their incentives.</p>
<h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>Vulnerable code:</p>
<p>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaIncentives.sol</p>
<p>Line 203 in 1465ba6</p>
<p> IERC20(token).transfer(msg.sender, amountToClaim); </p>
<p>Using msg.sender to send rewards to the caller without performing a check allows an attacker to impersonate a borrower and claim their incentives . Additionally, we can see that the function claimIncentives：<br>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaIncentives.sol</p>
<p>Lines 142 to 147 in 1465ba6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function claimIncentives( </span><br><span class="line">    address[] memory principles, </span><br><span class="line">    address[][] memory tokensIncentives, </span><br><span class="line">    uint epoch </span><br><span class="line">) public &#123; </span><br><span class="line">    // get information </span><br></pre></td></tr></table></figure>
<p>As long as the attacker forwards another person’s parameter information, they can impersonate them and claim the incentives<br>Internal pre-conditions<br>The claimIncentives function is public</p>
<h2 id="External-pre-conditions"><a href="#External-pre-conditions" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><p>No response</p>
<h2 id="Attack-Path"><a href="#Attack-Path" class="headerlink" title="Attack Path"></a>Attack Path</h2><ul>
<li>Alice has successfully borrowed tokens, and when she calls the claimIncentives function to claim the incentives, the transaction is packaged into the transaction pool.</li>
<li>Bob is always ready to monitor this transaction pool. Upon discovering Alice’s transaction, he can retrieve the transaction details (address[] memory principles, address[][] memory tokensIncentives, uint epoch), and then submit a higher gas fee for the same transaction, which will be processed first.</li>
<li>At this point, Bob impersonates Alice to claim her incentives. When Alice’s transaction is processed, she will be marked as having already claimed the incentives</li>
</ul>
<h2 id="Impact"><a href="#Impact" class="headerlink" title="Impact"></a>Impact</h2><p>Borrowers are unable to claim the rewards they are entitled to.<br>A front-running transaction attack occurs.</p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>Perform a check on the msg.sender calling the claimIncentives function.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function claimIncentives(</span><br><span class="line">    address[] memory principles,</span><br><span class="line">    address[][] memory tokensIncentives,</span><br><span class="line">    uint epoch,</span><br><span class="line">) public &#123;</span><br><span class="line">    // Ensure the caller is the borrower</span><br><span class="line">    require(msg.sender == borrower, &quot;Only the borrower can claim incentives&quot;);</span><br><span class="line"></span><br><span class="line">    // ... existing logic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ensure that this epoch ,the principal, and the borrower are correctly matched.</p>
<h1 id="二"><a href="#二" class="headerlink" title="二"></a>二</h1><h2 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h2><p>We all know that using transferFrom to send tokens lacks the security of using safeTransferFrom.</p>
<h2 id="Root-Cause-1"><a href="#Root-Cause-1" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>Vulnerable code:</p>
<p>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaIncentives.sol</p>
<p>Lines 269 to 274 in 1465ba6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IERC20(incentivizeToken).transferFrom( </span><br><span class="line">    msg.sender, </span><br><span class="line">    address(this), </span><br><span class="line">    amount </span><br><span class="line">); </span><br><span class="line"></span><br><span class="line">require(amount &gt; 0, &quot;Amount must be greater than 0&quot;); </span><br></pre></td></tr></table></figure>
<p>We can see that using transferFrom to transfer tokens to a contract is somewhat unsafe. Additionally, the operation of checking whether the amount is zero after the transfer is a bit redundant.<br>If it returns a bool value to determine whether the transfer was successful, then the vulnerability in the code is that it doesn’t check whether transferFrom actually succeeded.</p>
<h2 id="Internal-pre-conditions"><a href="#Internal-pre-conditions" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h2><p>No response</p>
<h2 id="External-pre-conditions-1"><a href="#External-pre-conditions-1" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><p>No response</p>
<h2 id="Attack-Path-1"><a href="#Attack-Path-1" class="headerlink" title="Attack Path"></a>Attack Path</h2><p>No response</p>
<h2 id="Impact-1"><a href="#Impact-1" class="headerlink" title="Impact"></a>Impact</h2><p>Using transferFrom to transfer tokens is less secure than safeTransferFrom.<br>We cannot be sure if transferFrom successfully completed the transfer.<br>Checking if the amount is zero after the transfer is performed in the wrong order.</p>
<h2 id="PoC-1"><a href="#PoC-1" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation-1"><a href="#Mitigation-1" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>Use the more secure safeTransferFrom for the token transfer.<br>Change the order of the check for whether the amount is zero.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       // transfer the tokens</span><br><span class="line">      // IERC20(incentivizeToken).transferFrom(</span><br><span class="line">    //     msg.sender,</span><br><span class="line">   //    address(this),</span><br><span class="line">  //     amount</span><br><span class="line"> //  );</span><br><span class="line">//   require(amount &gt; 0, &quot;Amount must be greater than 0&quot;);</span><br><span class="line">     </span><br><span class="line">     require(amount &gt; 0, &quot;Amount must be greater than 0&quot;);</span><br><span class="line">     SafeERC20.safeTransferFrom(</span><br><span class="line">           IERC20(incentivizeToken),</span><br><span class="line">         msg.sender,</span><br><span class="line">         address(this),</span><br><span class="line">         amount</span><br><span class="line">     );</span><br></pre></td></tr></table></figure>
<h1 id="三"><a href="#三" class="headerlink" title="三"></a>三</h1><h2 id="Summary-2"><a href="#Summary-2" class="headerlink" title="Summary"></a>Summary</h2><p>In the addFunds function of the DebitaLendOffer-Implementation contract, there is no check on theamountbeing added.</p>
<h2 id="Root-Cause-2"><a href="#Root-Cause-2" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>Valnerable code:</p>
<p>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaLendOffer-Implementation.sol</p>
<p>Lines 168 to 173 in 1465ba6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SafeERC20.safeTransferFrom( </span><br><span class="line">    IERC20(lendInformation.principle), </span><br><span class="line">    msg.sender, </span><br><span class="line">    address(this), </span><br><span class="line">    amount </span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p>As we can see, there is no check on the amount before the transfer, which allows the lender or owner to transfer zero tokens, wasting gas.</p>
<h2 id="Internal-pre-conditions-1"><a href="#Internal-pre-conditions-1" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h2><p>No response</p>
<h2 id="External-pre-conditions-2"><a href="#External-pre-conditions-2" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><p>No response</p>
<h2 id="Attack-Path-2"><a href="#Attack-Path-2" class="headerlink" title="Attack Path"></a>Attack Path</h2><p>If an attacker becomes a lender, they can repeatedly call the addFunds function, adding a large number of zero amounts to the DebitaLendOffer-Implementation contract, which prevents other lenders from adding their loan amounts.</p>
<h2 id="Impact-2"><a href="#Impact-2" class="headerlink" title="Impact"></a>Impact</h2><p>An attacker sends a large number of requests with a zero amount to the DebitaLendOffer-Implementation contract, consuming a lot of gas, which prevents legitimate lenders from adding loan amounts.<br>The DebitaLendOffer-Implementation contract will receive a large number of requests with a zero amount.</p>
<h2 id="PoC-2"><a href="#PoC-2" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation-2"><a href="#Mitigation-2" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>Add a check to ensure the amount is not zero, as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">require(amount &gt; 0, &quot;Amount must be greater than zero&quot;);</span><br><span class="line">SafeERC20.safeTransferFrom(</span><br><span class="line">       IERC20(lendInformation.principle),</span><br><span class="line">       msg.sender,</span><br><span class="line">       address(this),</span><br><span class="line">       amount</span><br><span class="line">   );</span><br></pre></td></tr></table></figure>
<h1 id="四"><a href="#四" class="headerlink" title="四"></a>四</h1><h2 id="Summary-3"><a href="#Summary-3" class="headerlink" title="Summary"></a>Summary</h2><p>Although the claimInterest function in the DebitaV3Loan.sol contract is marked as internal, there is still no check for the lender.</p>
<h2 id="Root-Cause-3"><a href="#Root-Cause-3" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>Valnerable code:</p>
<p>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaV3Loan.sol</p>
<p>Lines 259 to 269 in 1465ba6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function claimInterest(uint index) internal &#123; </span><br><span class="line">    IOwnerships ownershipContract = IOwnerships(s_OwnershipContract); </span><br><span class="line">    infoOfOffers memory offer = loanData._acceptedOffers[index]; </span><br><span class="line">    uint interest = offer.interestToClaim; </span><br><span class="line"> </span><br><span class="line">    require(interest &gt; 0, &quot;No interest to claim&quot;); </span><br><span class="line"> </span><br><span class="line">    loanData._acceptedOffers[index].interestToClaim = 0; </span><br><span class="line">    SafeERC20.safeTransfer(IERC20(offer.principle), msg.sender, interest); </span><br><span class="line">    Aggregator(AggregatorContract).emitLoanUpdated(address(this)); </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>As we can see from above, there is no check for the lender, which could lead to the interest being incorrectly claimed.<br>By comparing it with the function that has the same functionality, we can see that:<br>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaV3Loan.sol</p>
<p>Lines 288 to 311 in 1465ba6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function _claimDebt(uint index) internal &#123; </span><br><span class="line">    LoanData memory m_loan = loanData; </span><br><span class="line">    IOwnerships ownershipContract = IOwnerships(s_OwnershipContract); </span><br><span class="line"> </span><br><span class="line">    infoOfOffers memory offer = m_loan._acceptedOffers[index]; </span><br><span class="line">    require( </span><br><span class="line">        ownershipContract.ownerOf(offer.lenderID) == msg.sender, </span><br><span class="line">        &quot;Not lender&quot; </span><br><span class="line">    ); </span><br><span class="line">    require(offer.paid == true, &quot;Not paid&quot;); </span><br><span class="line">    require(offer.debtClaimed == false, &quot;Already claimed&quot;); </span><br><span class="line">    loanData._acceptedOffers[index].debtClaimed = true; </span><br><span class="line">    ownershipContract.burn(offer.lenderID); </span><br><span class="line">    uint interest = offer.interestToClaim; </span><br><span class="line">    offer.interestToClaim = 0; </span><br><span class="line"> </span><br><span class="line">    SafeERC20.safeTransfer( </span><br><span class="line">        IERC20(offer.principle), </span><br><span class="line">        msg.sender, </span><br><span class="line">        interest + offer.principleAmount </span><br><span class="line">    ); </span><br><span class="line"> </span><br><span class="line">    Aggregator(AggregatorContract).emitLoanUpdated(address(this)); </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>There still needs to be a check for the lender, as this would also serve as an additional layer of protection.</p>
<h2 id="Internal-pre-conditions-2"><a href="#Internal-pre-conditions-2" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h2><p>No response</p>
<h2 id="External-pre-conditions-3"><a href="#External-pre-conditions-3" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><p>No response</p>
<h2 id="Attack-Path-3"><a href="#Attack-Path-3" class="headerlink" title="Attack Path"></a>Attack Path</h2><p>No response</p>
<h2 id="Impact-3"><a href="#Impact-3" class="headerlink" title="Impact"></a>Impact</h2><p>This could lead to the interest being incorrectly claimed.</p>
<h2 id="PoC-3"><a href="#PoC-3" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation-3"><a href="#Mitigation-3" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>Add a check for the lender, as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function claimInterest(uint index) internal &#123;</span><br><span class="line">       IOwnerships ownershipContract = IOwnerships(s_OwnershipContract);</span><br><span class="line">       infoOfOffers memory offer = loanData._acceptedOffers[index];</span><br><span class="line">       uint interest = offer.interestToClaim;</span><br><span class="line"></span><br><span class="line">         require(</span><br><span class="line">           ownershipContract.ownerOf(offer.lenderID) == msg.sender,</span><br><span class="line">           &quot;Not lender&quot;</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       require(interest &gt; 0, &quot;No interest to claim&quot;);</span><br><span class="line"></span><br><span class="line">       loanData._acceptedOffers[index].interestToClaim = 0;</span><br><span class="line">       SafeERC20.safeTransfer(IERC20(offer.principle), msg.sender, interest);</span><br><span class="line">       Aggregator(AggregatorContract).emitLoanUpdated(address(this));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h1 id="五"><a href="#五" class="headerlink" title="五"></a>五</h1><h2 id="Summary-4"><a href="#Summary-4" class="headerlink" title="Summary"></a>Summary</h2><p>In the payDebt function of the DebitaV3Loan.sol contract, after calculating the interest, the safe transfer does not ensure that the address receiving the interest is not the zero address.</p>
<h2 id="Root-Cause-4"><a href="#Root-Cause-4" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>Vulnerable code:</p>
<p>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaV3Loan.sol</p>
<p>Lines 243 to 248 in 1465ba6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SafeERC20.safeTransferFrom( </span><br><span class="line">    IERC20(offer.principle), </span><br><span class="line">    msg.sender, </span><br><span class="line">    feeAddress, </span><br><span class="line">    feeOnInterest </span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p>As we can see from above, the safe transfer function of ERC20 is used, but it cannot ensure that feeOnInterest is not transferred to the zero address, resulting in irretrievable loss.</p>
<h2 id="Internal-pre-conditions-3"><a href="#Internal-pre-conditions-3" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h2><h2 id="External-pre-conditions-4"><a href="#External-pre-conditions-4" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><h2 id="Attack-Path-4"><a href="#Attack-Path-4" class="headerlink" title="Attack Path"></a>Attack Path</h2><p>No response</p>
<h2 id="Impact-4"><a href="#Impact-4" class="headerlink" title="Impact"></a>Impact</h2><p>The DebitaV3Loan.sol contract will lose the earned interest, which is a very unfortunate situation.</p>
<h2 id="PoC-4"><a href="#PoC-4" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation-4"><a href="#Mitigation-4" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>Perform a zero address check on feeAddress as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Check if feeAddress is the zero address</span><br><span class="line">  require(feeAddress != address(0), &quot;Invalid fee address: zero address&quot;);</span><br><span class="line"></span><br><span class="line">SafeERC20.safeTransferFrom(</span><br><span class="line">    IERC20(offer.principle),</span><br><span class="line">    msg.sender,</span><br><span class="line">    feeAddress,</span><br><span class="line">    feeOnInterest</span><br><span class="line">);\</span><br></pre></td></tr></table></figure>
<h1 id="六"><a href="#六" class="headerlink" title="六"></a>六</h1><h2 id="Summary-5"><a href="#Summary-5" class="headerlink" title="Summary"></a>Summary</h2><p>2024-11-debita-finance-v3-HeYuan-33&#x2F;Debita-V3-Contracts&#x2F;contracts&#x2F;DebitaBorrowOffer-Factory.sol</p>
<p>Lines 143 to 144 in 8d0c8c0</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uint balance = IERC20(_collateral).balanceOf(address(borrowOffer)); </span><br><span class="line">require(balance &gt;= _collateralAmount, &quot;Invalid balance&quot;); </span><br></pre></td></tr></table></figure>
<p>In thecontract, it checks whether the balance of an IERC20 token has successfully met the required amount, but it does not check the balance of an IERC721 token. If the user uses an IERC721 token as collateral, this check will fail, and it is also uncertain whether the IERC721 token has successfully entered the contract.DebitaBorrowOffer-Factory.sol<br>Root Cause<br>It only checks if the collateral staked by the user is an IERC20 token, and confirms whether the DebitaBorrowOffer-Factory.sol contract has enough IERC20 tokens.<br>This is an incorrect check, as if _collateral is an IERC721 token, this check will cause the contract to fail.</p>
<h2 id="Internal-pre-conditions-4"><a href="#Internal-pre-conditions-4" class="headerlink" title="Internal pre-conditions"></a>Internal pre-conditions</h2><p>No response</p>
<h2 id="External-pre-conditions-5"><a href="#External-pre-conditions-5" class="headerlink" title="External pre-conditions"></a>External pre-conditions</h2><p>No response</p>
<h2 id="Attack-Path-5"><a href="#Attack-Path-5" class="headerlink" title="Attack Path"></a>Attack Path</h2><h2 id="Impact-5"><a href="#Impact-5" class="headerlink" title="Impact"></a>Impact</h2><p>An attacker could use an IERC721 token as collateral. When the attacker takes out a loan and deposits the IERC721 token as collateral, it will cause the transaction to fail. If the attacker repeatedly executes the same transaction, it could potentially cause the contract to become unresponsive.</p>
<p>A legitimate user attempting to use an IERC721 token as collateral for a loan will also encounter an error, preventing the transaction from being processed, which would break the functionality of the contract.</p>
<p>An attacker can use an IERC721 token as collateral without successfully transferring it to the contract, effectively enabling them to borrow funds without providing any actual collateral.</p>
<h2 id="PoC-5"><a href="#PoC-5" class="headerlink" title="PoC"></a>PoC</h2><p>No response</p>
<h2 id="Mitigation-5"><a href="#Mitigation-5" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>To enhance the contract’s validation functionality, it should not only check if the IERC20 collateral has been successfully deposited into the DebitaBorrowOffer-Factory.sol contract, but also account for the case where the collateral is an IERC721 token. Below is the suggested modified code:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (_isNFT) &#123;</span><br><span class="line">    address nftOwner = IERC721(_collateral).ownerOf(_receiptID);</span><br><span class="line">    require(nftOwner == address(borrowOffer), &quot;NFT not transferred correctly&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    uint balance = IERC20(_collateral).balanceOf(address(borrowOffer));</span><br><span class="line">    require(balance &gt;= _collateralAmount, &quot;Invalid balance&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>感觉还是很难。就是发现不了他们的错误。这个合约的逻辑很缜密，所以只有等正确的审计报告出来，然后再多学习学习</p>
<h2 id="这次的审计，有让我学会一些东西，在函数中定义重复owner-会导致改变的量状态不同，比如这次的合约中，就错误的使用了owner"><a href="#这次的审计，有让我学会一些东西，在函数中定义重复owner-会导致改变的量状态不同，比如这次的合约中，就错误的使用了owner" class="headerlink" title="这次的审计，有让我学会一些东西，在函数中定义重复owner,会导致改变的量状态不同，比如这次的合约中，就错误的使用了owner;"></a>这次的审计，有让我学会一些东西，在函数中定义重复owner,会导致改变的量状态不同，比如这次的合约中，就错误的使用了owner;</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function changeOwner(address owner) public &#123;</span><br><span class="line">      require(msg.sender == owner, &quot;Only owner&quot;);</span><br><span class="line">      require(deployedTime + 6 hours &gt; block.timestamp, &quot;6 hours passed&quot;);</span><br><span class="line">      owner = owner;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>当你像改变合约的owner时，由于传递的参数和合约的状态变量owner一样，所以就是自己赋值<br>这里的 owner 参数与状态变量 owner 同名，这就导致了一个作用域的问题。<br>在 Solidity 中，函数参数的作用域优先于状态变量，这意味着在函数内部，owner 会首先指代函数的参数 address owner，而不是合约的状态变量 owner。<br>因此，owner &#x3D; owner; 只是将函数的参数 owner 赋值给它自己，并没有对链上的状态变量 owner 做任何修改。<br>详细解释<br>函数参数优先级： 当你在函数中定义一个与状态变量同名的参数时，函数会优先使用该参数，而不是状态变量。也就是说，在函数内部，owner 这个名字指代的是参数 address owner，而不是链上的状态变量。<br>赋值的行为：<br>owner &#x3D; owner; 这行代码看似是给状态变量 owner 赋值，但实际上它只是给函数参数 owner 赋值。由于函数参数和状态变量是不同的存储位置，这行代码并没有实际改变链上的状态变量。<br>在 Solidity 中，owner &#x3D; owner; 是一个 自我赋值，没有任何效果，除非你在这个赋值中显式地引用状态变量。</p>
<blockquote>
<p>状态变量（State Variables）：状态变量存储在区块链上，生命周期与合约相同，可以在整个合约中访问和修改。<br>函数参数（Function Arguments）：这些变量仅在函数执行期间有效，当函数执行完后，它们就不再存在。<br>局部变量（Local Variables）：在函数内部声明的变量，它们只在函数的执行期间有效。</p>
</blockquote>
<h2 id="可以通过执行存款，阻止借贷订单的取消"><a href="#可以通过执行存款，阻止借贷订单的取消" class="headerlink" title="可以通过执行存款，阻止借贷订单的取消"></a>可以通过执行存款，阻止借贷订单的取消</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function addFunds(uint amount) public nonReentrant &#123;  </span><br><span class="line">       require(  </span><br><span class="line">           msg.sender == lendInformation.owner ||  </span><br><span class="line">               IAggregator(aggregatorContract).isSenderALoan(msg.sender),  </span><br><span class="line">           &quot;Only owner or loan&quot;  </span><br><span class="line">       );  </span><br><span class="line">       SafeERC20.safeTransferFrom(  </span><br><span class="line">           IERC20(lendInformation.principle),  </span><br><span class="line">           msg.sender,  </span><br><span class="line">           address(this),  </span><br><span class="line">           amount  </span><br><span class="line">       );  </span><br><span class="line">       lendInformation.availableAmount += amount;  </span><br><span class="line">       IDLOFactory(factoryContract).emitUpdate(address(this));  </span><br><span class="line">   &#125;  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function cancelOffer() public onlyOwner nonReentrant &#123;  </span><br><span class="line">        uint availableAmount = lendInformation.availableAmount;  </span><br><span class="line">        lendInformation.perpetual = false;  </span><br><span class="line">        lendInformation.availableAmount = 0;  </span><br><span class="line">@&gt;        require(availableAmount &gt; 0, &quot;No funds to cancel&quot;);  </span><br><span class="line">        isActive = false;  </span><br><span class="line">  </span><br><span class="line">        SafeERC20.safeTransfer(  </span><br><span class="line">            IERC20(lendInformation.principle),  </span><br><span class="line">            msg.sender,  </span><br><span class="line">            availableAmount  </span><br><span class="line">        );  </span><br><span class="line">        IDLOFactory(factoryContract).emitDelete(address(this));  </span><br><span class="line">@&gt;        IDLOFactory(factoryContract).deleteOrder(address(this));  </span><br><span class="line">        // emit canceled event on factory  </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  function deleteOrder(address _lendOrder) external onlyLendOrder &#123;  </span><br><span class="line">        uint index = LendOrderIndex[_lendOrder];  </span><br><span class="line">        LendOrderIndex[_lendOrder] = 0;  </span><br><span class="line">  </span><br><span class="line">        // switch index of the last borrow order to the deleted borrow order  </span><br><span class="line">        allActiveLendOrders[index] = allActiveLendOrders[activeOrdersCount - 1];  </span><br><span class="line">        LendOrderIndex[allActiveLendOrders[activeOrdersCount - 1]] = index;  </span><br><span class="line">  </span><br><span class="line">        // take out last borrow order  </span><br><span class="line">  </span><br><span class="line">        allActiveLendOrders[activeOrdersCount - 1] = address(0);  </span><br><span class="line">  </span><br><span class="line">@&gt;        activeOrdersCount--;  </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>
<p>攻击者可以利用 addFunds 函数中缺失的活跃订单检查，向一个 非活跃的借贷订单 中添加资金。这样，攻击者可以通过以下步骤触发攻击：</p>
<p>攻击者创建一个借贷订单，并通过 DLOFactory::activeOrdersCount 增加活跃订单计数。<br>攻击者调用 cancelOffer 函数取消该借贷订单，并调用 deleteOrder 减少活跃订单计数。<br>然后，攻击者向该已取消的借贷订单中添加资金，成功绕过了 cancelOffer 中的检查，允许 addFunds 通过。<br>攻击者继续调用 cancelOffer，进一步将活跃订单计数减少。<br>最终，攻击者将 DLOFactory::activeOrdersCount 计数降为 0。<br>当 activeOrdersCount 为零时，后续调用 deleteOrder 或相关函数将因为算术下溢（underflow）而失败，导致后续功能无法正常执行。<br>根本原因<br>问题出在 DLOImplementation::addFunds 函数中，它没有检查订单是否处于活跃状态。正常情况下，只有活跃订单才能向其中添加资金。但是，由于缺少这一检查，攻击者可以向一个已经取消的订单中添加资金，从而绕过订单取消的逻辑。<br>这个漏洞就是需要结合逻辑一起看，看它的检查条件，能不能绕过然后发生攻击，这次主要看合约的实现漏洞了，没有发现逻辑上可以绕过的点</p>
<h2 id="没有统一单位（10-18-10-8）往往会出现计算错误"><a href="#没有统一单位（10-18-10-8）往往会出现计算错误" class="headerlink" title="没有统一单位（10^18,10^8）往往会出现计算错误"></a>没有统一单位（10^18,10^8）往往会出现计算错误</h2><h2 id="下溢的问题"><a href="#下溢的问题" class="headerlink" title="下溢的问题"></a>下溢的问题</h2><p>好遗憾，最开始的时候还注意了这个地方，但是想到solidity 8.0 之后会检查溢出的，就没有太注意，但是其实是有一个报错返回的，那么就可以使DOS攻击</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uint256 alreadyUsedTime = block.timestamp - loanStartedAt;</span><br><span class="line">uint256 extendedTime = maxDeadline - alreadyUsedTime - block.timestamp;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alreadyUsedTime = currentTime - loanStartedAt = 1705190400 - 1704067200 = 1,123,200（大约13天）</span><br><span class="line">extendedTime = maxDeadline - alreadyUsedTime - currentTime = 1705276800 - 1,123,200 - 1705190400</span><br><span class="line">             = 1705276800 - 1706313600</span><br><span class="line">             = -1,036,800</span><br></pre></td></tr></table></figure>
<p>这个 extendedTime 变量并没有被实际使用，但它会影响合约中的计算，导致算术下溢错误。在某些情况下，借款人即使满足所有其他扩展条件，仍然无法扩展贷款。<br>其实就是就是影响了用户的体验</p>
<h2 id="跳过白名单，直接阻断了后续的领取代币"><a href="#跳过白名单，直接阻断了后续的领取代币" class="headerlink" title="跳过白名单，直接阻断了后续的领取代币"></a>跳过白名单，直接阻断了后续的领取代币</h2><p>这个函数也是我反复看的，但是差点，没有发现如果直接return的话，那么就会导致后面满足白名单的人不能够领取奖励，又是一个遗憾</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function updateFunds(  </span><br><span class="line">    infoOfOffers[] memory informationOffers,  </span><br><span class="line">    address collateral,  </span><br><span class="line">    address[] memory lenders,  </span><br><span class="line">    address borrower  </span><br><span class="line">) public onlyAggregator &#123;  </span><br><span class="line">    for (uint i = 0; i &lt; lenders.length; i++) &#123;  </span><br><span class="line">        bool validPair = isPairWhitelisted[informationOffers[i].principle][  </span><br><span class="line">            collateral  </span><br><span class="line">        ];  </span><br><span class="line">        if (!validPair) &#123;  </span><br><span class="line">            return;  // 这里的return导致函数提前退出，跳过后续有效的配对</span><br><span class="line">        &#125;  </span><br><span class="line">        address principle = informationOffers[i].principle;  </span><br><span class="line">        uint _currentEpoch = currentEpoch();  </span><br><span class="line">        lentAmountPerUserPerEpoch[lenders[i]][  </span><br><span class="line">            hashVariables(principle, _currentEpoch)  </span><br><span class="line">        ] += informationOffers[i].principleAmount;  </span><br><span class="line">        totalUsedTokenPerEpoch[principle][  </span><br><span class="line">            _currentEpoch  </span><br><span class="line">        ] += informationOffers[i].principleAmount;  </span><br><span class="line">        borrowAmountPerEpoch[borrower][  </span><br><span class="line">            hashVariables(principle, _currentEpoch)  </span><br><span class="line">        ] += informationOffers[i].principleAmount;  </span><br><span class="line">        emit UpdatedFunds(  </span><br><span class="line">            lenders[i],  </span><br><span class="line">            principle,  </span><br><span class="line">            collateral,  </span><br><span class="line">            borrower,  </span><br><span class="line">            _currentEpoch  </span><br><span class="line">        );  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="FOT代币，在转账的时候会产生手续费，就会导致一些计算失败"><a href="#FOT代币，在转账的时候会产生手续费，就会导致一些计算失败" class="headerlink" title="FOT代币，在转账的时候会产生手续费，就会导致一些计算失败"></a>FOT代币，在转账的时候会产生手续费，就会导致一些计算失败</h2><p>在 TaxTokensReceipt 合约中，存在一个问题，导致 Fee-on-Transfer (FOT) 代币在存款时出现交易回滚。问题的根本原因是合约假设用户存入的代币数量与转账的实际数量相同，但对于 Fee-on-Transfer 代币，转账过程中会扣除一定的费用。因此，合约在检查代币差额时，总是期望接收到与用户指定数量相等的金额，但实际收到的数量较少，导致存款失败。<br>Fee-on-Transfer (FOT) 代币：这类代币在每次转账时会自动扣除一定比例的费用，导致转账到合约的实际金额（difference）少于用户指定的存款金额（amount）。<br>问题发生的位置：在 TaxTokensReceipt.sol 合约的 deposit() 函数中，合约将转账前后的余额差（difference）与用户指定的 amount 进行比较，假设两者应当相等。然而，由于 FOT 代币的费用机制，实际转账的金额始终少于用户指定的 amount，因此 difference &gt;&#x3D; amount 检查始终失败，导致交易回滚。</p>
<p>又是一个新的知识，FOT代币，会有手续费</p>
<h2 id="预言机没有检查时间过时，导致价格更新不一致"><a href="#预言机没有检查时间过时，导致价格更新不一致" class="headerlink" title="预言机没有检查时间过时，导致价格更新不一致"></a>预言机没有检查时间过时，导致价格更新不一致</h2><p>DebitaChainlink.sol 合约中的 getThePrice() 函数对 Chainlink 价格预言机的数据进行验证时，存在验证不完整的问题。虽然函数进行了一些基本的检查（如合约是否暂停、价格预言机是否存在、L2序列器是否正常等），但它缺少对价格更新时间戳、回合完整性以及回合排序的验证。这意味着，即使价格预言机的数据已经过时（但价格仍大于零），合约仍然会接受这些数据，可能导致使用陈旧或无效的价格。</p>
<p>根本原因：<br>getThePrice() 函数目前只验证了以下几点：</p>
<p>合约是否暂停（isPaused）。<br>价格预言机是否存在。<br>L2序列器是否正常（对于L2链）。<br>返回的价格是否大于零。<br>然而，它没有验证：</p>
<p>价格更新的时间戳（updatedAt）。<br>回合是否完整（answeredInRound）。<br>回合是否按顺序回答（answeredInRound &gt;&#x3D; roundId）。<br>合约中的 getThePrice() 函数从 Chainlink 价格预言机获取最新价格数据时，验证逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(, int price, , , ) = priceFeed.latestRoundData();  </span><br><span class="line">require(isFeedAvailable[_priceFeed], &quot;Price feed not available&quot;);  </span><br><span class="line">require(price &gt; 0, &quot;Invalid price&quot;);  </span><br></pre></td></tr></table></figure>
<p>但没有进一步验证价格是否来自一个有效的回合，或者回合是否完整。也没有检查 updatedAt 时间戳，可能导致使用陈旧的价格数据。具体来说，以下情况未被考虑：</p>
<p>时间戳验证缺失： 如果预言机数据的更新时间戳很久之前，那么这个价格数据就是“过时”的，应该拒绝使用。<br>回合完整性检查： 如果价格数据属于一个不完整的回合（例如，数据没有完全更新），则无法保证其准确性。<br>回合顺序验证： 需要确保返回的回合数据是按顺序的，否则有可能是过时的无效数据。</p>
<p>使用预言机的话，就要注意到这几个细节<br>配置更新时间阈值： 为了应对不同的市场环境，可以让合约所有者设置一个自定义的价格数据有效时间（比如，10分钟或者更短）。<br>价格验证事件： 在每次价格验证时，触发事件记录价格数据的验证状态，这有助于监控和审计价格来源的健康状态。<br>公开数据接口： 提供一个视图函数，返回包括时间戳和回合 ID 在内的完整价格数据，供外部用户验证和分析。<br>时间戳验证缺失： 如果预言机数据的更新时间戳很久之前，那么这个价格数据就是“过时”的，应该拒绝使用。<br>回合完整性检查： 如果价格数据属于一个不完整的回合（例如，数据没有完全更新），则无法保证其准确性。<br>回合顺序验证： 需要确保返回的回合数据是按顺序的，否则有可能是过时的无效数据。</p>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">何方圜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/11/24/sherlock-2024-11-debita-Finance-V3/">http://example.com/2024/11/24/sherlock-2024-11-debita-Finance-V3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://https://HeYuan-33.github.io/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/">审计报告</a></div><div class="post_share"><div class="social-share" data-image="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/11/25/sherlock-Superfluid-Locker-System-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="sherlock-Superfluid Locker System 审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">sherlock-Superfluid Locker System 审计报告</div></div></a></div><div class="next-post pull-right"><a href="/2024/11/23/Palmswap%E6%94%BB%E5%87%BB%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%88%86%E6%9E%90/" title="Palmswap攻击事件的分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">Palmswap攻击事件的分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/11/11/CodeHawks-GivingThanks%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="CodeHawks-GivingThanks审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-11</div><div class="title">CodeHawks-GivingThanks审计报告</div></div></a></div><div><a href="/2024/12/04/codeHawks-2024-11-twentyone-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="codeHawks-2024-11-twentyone 审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-04</div><div class="title">codeHawks-2024-11-twentyone 审计报告</div></div></a></div><div><a href="/2024/11/17/sherlock-2024-11-VVV%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="sherlock-2024-11-VVV审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-17</div><div class="title">sherlock-2024-11-VVV审计报告</div></div></a></div><div><a href="/2024/11/25/sherlock-Superfluid-Locker-System-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="sherlock-Superfluid Locker System 审计报告"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-25</div><div class="title">sherlock-Superfluid Locker System 审计报告</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/1219ec3412a4cedf9378f9c0b14545e1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">何方圜</div><div class="author-info__description">夫孰异道而相安</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">91</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HeYuan-33/HeYuan-33.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HeYuan-33" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="/1405269390@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">CTF的更新</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80"><span class="toc-text">一</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C"><span class="toc-text">二</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-1"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause-1"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-pre-conditions"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions-1"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path-1"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact-1"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC-1"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation-1"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89"><span class="toc-text">三</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-2"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause-2"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-pre-conditions-1"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions-2"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path-2"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact-2"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC-2"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation-2"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B"><span class="toc-text">四</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-3"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause-3"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-pre-conditions-2"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions-3"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path-3"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact-3"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC-3"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation-3"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94"><span class="toc-text">五</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-4"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Cause-4"><span class="toc-text">Root Cause</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-pre-conditions-3"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions-4"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path-4"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact-4"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC-4"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation-4"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD"><span class="toc-text">六</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-5"><span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-pre-conditions-4"><span class="toc-text">Internal pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#External-pre-conditions-5"><span class="toc-text">External pre-conditions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Attack-Path-5"><span class="toc-text">Attack Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Impact-5"><span class="toc-text">Impact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC-5"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation-5"><span class="toc-text">Mitigation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%99%E6%AC%A1%E7%9A%84%E5%AE%A1%E8%AE%A1%EF%BC%8C%E6%9C%89%E8%AE%A9%E6%88%91%E5%AD%A6%E4%BC%9A%E4%B8%80%E4%BA%9B%E4%B8%9C%E8%A5%BF%EF%BC%8C%E5%9C%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E5%AE%9A%E4%B9%89%E9%87%8D%E5%A4%8Downer-%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%94%B9%E5%8F%98%E7%9A%84%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%8D%E5%90%8C%EF%BC%8C%E6%AF%94%E5%A6%82%E8%BF%99%E6%AC%A1%E7%9A%84%E5%90%88%E7%BA%A6%E4%B8%AD%EF%BC%8C%E5%B0%B1%E9%94%99%E8%AF%AF%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BA%86owner"><span class="toc-text">这次的审计，有让我学会一些东西，在函数中定义重复owner,会导致改变的量状态不同，比如这次的合约中，就错误的使用了owner;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%89%A7%E8%A1%8C%E5%AD%98%E6%AC%BE%EF%BC%8C%E9%98%BB%E6%AD%A2%E5%80%9F%E8%B4%B7%E8%AE%A2%E5%8D%95%E7%9A%84%E5%8F%96%E6%B6%88"><span class="toc-text">可以通过执行存款，阻止借贷订单的取消</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E7%BB%9F%E4%B8%80%E5%8D%95%E4%BD%8D%EF%BC%8810-18-10-8%EF%BC%89%E5%BE%80%E5%BE%80%E4%BC%9A%E5%87%BA%E7%8E%B0%E8%AE%A1%E7%AE%97%E9%94%99%E8%AF%AF"><span class="toc-text">没有统一单位（10^18,10^8）往往会出现计算错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E6%BA%A2%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">下溢的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E8%BF%87%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%8C%E7%9B%B4%E6%8E%A5%E9%98%BB%E6%96%AD%E4%BA%86%E5%90%8E%E7%BB%AD%E7%9A%84%E9%A2%86%E5%8F%96%E4%BB%A3%E5%B8%81"><span class="toc-text">跳过白名单，直接阻断了后续的领取代币</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FOT%E4%BB%A3%E5%B8%81%EF%BC%8C%E5%9C%A8%E8%BD%AC%E8%B4%A6%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E4%BA%A7%E7%94%9F%E6%89%8B%E7%BB%AD%E8%B4%B9%EF%BC%8C%E5%B0%B1%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%B8%80%E4%BA%9B%E8%AE%A1%E7%AE%97%E5%A4%B1%E8%B4%A5"><span class="toc-text">FOT代币，在转账的时候会产生手续费，就会导致一些计算失败</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E8%A8%80%E6%9C%BA%E6%B2%A1%E6%9C%89%E6%A3%80%E6%9F%A5%E6%97%B6%E9%97%B4%E8%BF%87%E6%97%B6%EF%BC%8C%E5%AF%BC%E8%87%B4%E4%BB%B7%E6%A0%BC%E6%9B%B4%E6%96%B0%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="toc-text">预言机没有检查时间过时，导致价格更新不一致</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1"><span class="toc-text"></span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/06/CTF-ApproveMain/" title="CTF-ApproveMain">CTF-ApproveMain</a><time datetime="2024-12-06T13:04:35.000Z" title="Created 2024-12-06 21:04:35">2024-12-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/06/CTF-EverythingArt/" title="CTF-EverythingArt">CTF-EverythingArt</a><time datetime="2024-12-06T12:47:23.000Z" title="Created 2024-12-06 20:47:23">2024-12-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/06/%E5%85%B3%E4%BA%8Esolidity%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" title="关于solidity漏洞的基础知识">关于solidity漏洞的基础知识</a><time datetime="2024-12-06T11:15:37.000Z" title="Created 2024-12-06 19:15:37">2024-12-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/04/codeHawks-2024-11-twentyone-%E5%AE%A1%E8%AE%A1%E6%8A%A5%E5%91%8A/" title="codeHawks-2024-11-twentyone 审计报告">codeHawks-2024-11-twentyone 审计报告</a><time datetime="2024-12-04T10:10:07.000Z" title="Created 2024-12-04 18:10:07">2024-12-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/02/CTF-Storage/" title="CTF-Storage">CTF-Storage</a><time datetime="2024-12-02T13:47:15.000Z" title="Created 2024-12-02 21:47:15">2024-12-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/8a5725b44b17e750ba6ce84aaca3013d.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 何方圜</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>